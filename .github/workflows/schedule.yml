name: Nightly Job at 2AM IST

on:
  schedule:
    - cron: "30 20 * * *"   # Runs at 02:00 AM IST daily
  workflow_dispatch:

permissions:
  contents: write     # REQUIRED to allow git push using GITHUB_TOKEN

jobs:
  run-task:
    runs-on: ubuntu-latest
    env:
      REPORT_GLOB_1: "Accepted_*_Report.xlsx"
      REPORT_GLOB_2: "Rejected_*_Report.xlsx"
      REPORT_GLOB_3: "Summary_*_Report.txt"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true   # needed to push using GITHUB_TOKEN

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-file.txt

      - name: Run News Scraper
        id: scraper
        run: |
          python news_scraper.py
          TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Debug - List generated files
        run: |
          ls -lah

      # -------------------------------------------------------------
      # Upload reports as artifacts (ALWAYS)
      # -------------------------------------------------------------
      - name: Upload Generated Reports
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ env.TIMESTAMP }}
          path: |
            ${{ env.REPORT_GLOB_1 }}
            ${{ env.REPORT_GLOB_2 }}
            ${{ env.REPORT_GLOB_3 }}

      # -------------------------------------------------------------
      # COMMIT & PUSH FOR BOTH SCHEDULED AND MANUAL RUNS
      # -------------------------------------------------------------
      - name: Move generated files into repo folder
        run: |
          mkdir -p reports
          for f in Accepted_*_Report.xlsx Rejected_*_Report.xlsx Summary_*_Report.txt; do
            if [ -f "$f" ]; then
              mv -f "$f" reports/
            fi
          done
          ls -lah reports

      - name: Commit changes back to repo (ALL RUNS)
        env:
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          git config user.name "$GIT_COMMITTER_NAME"
          git config user.email "$GIT_COMMITTER_EMAIL"
          
          git add reports/*
          
          if git diff --cached --quiet; then
            echo "No changes detected; skipping commit."
            exit 0
          fi
          
          git commit -m "Auto-update reports for ${{ env.TIMESTAMP }}"
          git push origin HEAD:${{ github.ref_name }}
